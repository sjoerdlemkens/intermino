name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸšš Checkout code
        uses: actions/checkout@v3

      - name: ğŸ“œ Get Flutter version from .fvmrc
        id: flutter-version
        run: |
          echo "FLUTTER_VERSION=$(jq -r '.flutter' .fvmrc)" >> $GITHUB_ENV

      - name: ğŸ’» Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: ğŸ—„ï¸ Cache Flutter and Dart dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            **/.dart_tool
            **/build
          key: ${{ runner.os }}-flutter-pub-cache-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-pub-cache-

      - name: ğŸŒ‹ Set up Melos & Install Dependencies
        uses: bluefireteam/melos-action@v3
        with:
          run-bootstrap: true

      - name: âœ¨ Verify formatting
        run: melos format

      - name: ğŸ”¨ Build generated code
        run: melos build_runner

      - name: ğŸ” Analyze code
        run: melos lint

      - name: ğŸ§ª Run tests
        run: melos test
